<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¥— ×“×™××˜×” ×‘×™×—×“</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;700;900&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0a0e1a;font-family:'Heebo',sans-serif;color:#e2e8f0}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    ::-webkit-scrollbar{width:4px;height:4px}
    ::-webkit-scrollbar-track{background:#0a0e1a}
    ::-webkit-scrollbar-thumb{background:#1e293b;border-radius:4px}
    button:hover{opacity:.85}
    input:focus,textarea:focus{border-color:#4ade8066!important;outline:none}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

const API = "https://diet-backend-production-a76e.up.railway.app";

const api = {
  token: () => sessionStorage.getItem("diet_token"),
  async req(method, path, body) {
    const res = await fetch(`${API}${path}`, {
      method,
      headers: {"Content-Type":"application/json", ...(api.token()?{Authorization:`Bearer ${api.token()}`}:{})},
      body: body ? JSON.stringify(body) : undefined,
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "×©×’×™××”");
    return data;
  },
  get: p => api.req("GET", p),
  post: (p,b) => api.req("POST", p, b),
  put: (p,b) => api.req("PUT", p, b),
  async load(key) { const d = await api.get(`/api/data/${key}`); return d.value; },
  async save(key, value) { await api.put(`/api/data/${key}`, { value }); },
};

function callClaude(messages, system) {
  return fetch(`${API}/api/claude`, {
    method:"POST",
    headers:{"Content-Type":"application/json", "Authorization":`Bearer ${api.token()}`},
    body:JSON.stringify({messages, system}),
  }).then(r=>r.json()).then(d=>d.content?.[0]?.text||"");
}

function calcBMR({gender,age,heightCm,weightKg,activityLevel=1.375}) {
  if (!age||!heightCm||!weightKg) return null;
  const bmr = gender==="male"
    ? 10*weightKg+6.25*heightCm-5*age+5
    : 10*weightKg+6.25*heightCm-5*age-161;
  const tdee = Math.round(bmr*activityLevel);
  return {bmr:Math.round(bmr),tdee,target:Math.round(tdee-500)};
}

const COLORS = ["#4ade80","#f472b6","#60a5fa","#fb923c","#a78bfa","#34d399"];
function ucolor(id) { return COLORS[Math.abs(parseInt(String(id).slice(-3),10))%COLORS.length]; }

function Avatar({name,color,size=36}) {
  const i = (name||"?").split(" ").map(w=>w[0]).join("").toUpperCase().slice(0,2);
  return <div style={{width:size,height:size,borderRadius:"50%",backgroundColor:color+"33",border:`2px solid ${color}`,display:"flex",alignItems:"center",justifyContent:"center",color,fontWeight:700,fontSize:size*.38,flexShrink:0}}>{i}</div>;
}

// â”€â”€ Simple SVG line chart (no library needed) â”€â”€
function LineChart({data, xKey, yKey, color, height=200}) {
  if (!data||data.length<2) return null;
  const vals = data.map(d=>d[yKey]);
  const min = Math.min(...vals), max = Math.max(...vals);
  const range = max-min||1;
  const w = 600, h = height;
  const pad = {t:10,r:10,b:30,l:40};
  const iw = w-pad.l-pad.r, ih = h-pad.t-pad.b;
  const px = i => pad.l + (i/(data.length-1))*iw;
  const py = v => pad.t + (1-(v-min)/range)*ih;
  const points = data.map((d,i)=>`${px(i)},${py(d[yKey])}`).join(" ");
  const area = `${px(0)},${pad.t+ih} ${points} ${px(data.length-1)},${pad.t+ih}`;

  return (
    <svg viewBox={`0 0 ${w} ${h}`} style={{width:"100%",height}} preserveAspectRatio="none">
      {/* Grid lines */}
      {[0,.25,.5,.75,1].map(t=>{
        const y = pad.t+t*ih;
        const val = max-t*range;
        return <g key={t}>
          <line x1={pad.l} y1={y} x2={pad.l+iw} y2={y} stroke="#1e293b" strokeWidth="1"/>
          <text x={pad.l-4} y={y+4} textAnchor="end" fill="#64748b" fontSize="11">{Math.round(val)}</text>
        </g>;
      })}
      {/* X labels */}
      {data.map((d,i)=>(
        i%Math.ceil(data.length/6)===0&&<text key={i} x={px(i)} y={h-4} textAnchor="middle" fill="#64748b" fontSize="10">{d[xKey]}</text>
      ))}
      {/* Area fill */}
      <polygon points={area} fill={color+"22"} />
      {/* Line */}
      <polyline points={points} fill="none" stroke={color} strokeWidth="2.5" strokeLinejoin="round" strokeLinecap="round"/>
      {/* Dots */}
      {data.map((d,i)=><circle key={i} cx={px(i)} cy={py(d[yKey])} r="4" fill={color} stroke="#0a0e1a" strokeWidth="2"/>)}
    </svg>
  );
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ROOT
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function App() {
  const [user, setUser] = useState(null);
  const [checking, setChecking] = useState(true);

  useEffect(()=>{
    const token = sessionStorage.getItem("diet_token");
    if (!token){setChecking(false);return;}
    api.get("/api/me").then(d=>setUser(d.user)).catch(()=>sessionStorage.removeItem("diet_token")).finally(()=>setChecking(false));
  },[]);

  if (checking) return <Spin/>;
  if (!user) return <Auth onAuth={(u,t)=>{sessionStorage.setItem("diet_token",t);setUser(u);}}/>;
  return <DietApp user={user} onOut={()=>{sessionStorage.removeItem("diet_token");setUser(null);}}/>;
}

function Spin(){return <div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",backgroundColor:"#0a0e1a",gap:12,color:"#4ade80"}}><div style={{width:36,height:36,border:"3px solid #1e293b",borderTop:"3px solid #4ade80",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>×˜×•×¢×Ÿ...</div>;}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// AUTH
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function Auth({onAuth}) {
  const [mode,setMode]=useState("login");
  const [name,setName]=useState("");
  const [email,setEmail]=useState("");
  const [pw,setPw]=useState("");
  const [loading,setLoading]=useState(false);
  const [err,setErr]=useState("");

  async function submit(){
    setErr("");
    if(!email||!pw){setErr("× × ×œ××œ× ××™×™×œ ×•×¡×™×¡××”");return;}
    if(mode==="register"&&!name.trim()){setErr("× × ×œ×”×›× ×™×¡ ×©×");return;}
    setLoading(true);
    try{
      const d=await api.post(mode==="register"?"/api/register":"/api/login",
        mode==="register"?{email,password:pw,name}:{email,password:pw});
      onAuth(d.user,d.token);
    }catch(e){setErr(e.message);}
    setLoading(false);
  }

  const inp={padding:"12px 16px",borderRadius:12,border:"1px solid #1e293b",backgroundColor:"#0a0e1a",color:"#e2e8f0",fontFamily:"Heebo,sans-serif",fontSize:15,outline:"none",width:"100%"};

  return(
    <div style={{minHeight:"100vh",backgroundColor:"#0a0e1a",display:"flex",alignItems:"center",justifyContent:"center",padding:20,position:"relative",overflow:"hidden"}}>
      <div style={{position:"absolute",width:500,height:500,borderRadius:"50%",background:"radial-gradient(circle,#4ade8015 0%,transparent 70%)",top:-200,right:-100}}/>
      <div style={{position:"absolute",width:400,height:400,borderRadius:"50%",background:"radial-gradient(circle,#60a5fa10 0%,transparent 70%)",bottom:-100,left:-50}}/>
      <div style={{backgroundColor:"#0f1117",border:"1px solid #1e293b",borderRadius:24,padding:"40px 36px",width:"100%",maxWidth:420,position:"relative",zIndex:1,boxShadow:"0 25px 60px #00000066"}}>
        <div style={{textAlign:"center",marginBottom:30}}>
          <div style={{fontSize:52,marginBottom:6}}>ğŸ¥—</div>
          <h1 style={{fontSize:28,fontWeight:900,margin:0,background:"linear-gradient(135deg,#4ade80,#60a5fa)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>×“×™××˜×” ×‘×™×—×“</h1>
          <p style={{color:"#475569",margin:"6px 0 0",fontSize:14}}>×”××¡×¢ ×©×œ× ×• ×œ×—×™×™× ×‘×¨×™××™×</p>
        </div>
        <div style={{display:"flex",backgroundColor:"#0a0e1a",borderRadius:12,padding:4,marginBottom:24,border:"1px solid #1e293b"}}>
          {["login","register"].map(m=>(
            <button key={m} onClick={()=>{setMode(m);setErr("");}} style={{flex:1,padding:9,borderRadius:9,border:"none",cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:15,fontWeight:600,backgroundColor:mode===m?"#1e293b":"transparent",color:mode===m?"#e2e8f0":"#64748b"}}>
              {m==="login"?"×”×ª×—×‘×¨×•×ª":"×”×¨×©××”"}
            </button>
          ))}
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:14}}>
          {mode==="register"&&<div style={{display:"flex",flexDirection:"column",gap:6}}><label style={{color:"#64748b",fontSize:13,fontWeight:600}}>×©× ×ª×¦×•×’×”</label><input placeholder="××™×š × ×§×¨× ×œ×š?" value={name} onChange={e=>setName(e.target.value)} style={inp}/></div>}
          <div style={{display:"flex",flexDirection:"column",gap:6}}><label style={{color:"#64748b",fontSize:13,fontWeight:600}}>××™××™×™×œ</label><input type="email" placeholder="name@example.com" value={email} onChange={e=>setEmail(e.target.value)} style={{...inp,direction:"ltr"}}/></div>
          <div style={{display:"flex",flexDirection:"column",gap:6}}><label style={{color:"#64748b",fontSize:13,fontWeight:600}}>×¡×™×¡××”</label><input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value={pw} onChange={e=>setPw(e.target.value)} onKeyDown={e=>e.key==="Enter"&&submit()} style={{...inp,direction:"ltr"}}/></div>
          {err&&<div style={{backgroundColor:"#f8717120",border:"1px solid #f8717144",borderRadius:10,padding:"10px 14px",color:"#f87171",fontSize:14}}>âš ï¸ {err}</div>}
          <button onClick={submit} disabled={loading} style={{padding:14,borderRadius:12,border:"none",backgroundColor:"#4ade80",color:"#0a0e1a",fontWeight:700,cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:16,opacity:loading?.6:1}}>
            {loading?"â³ ×¨×’×¢...":mode==="login"?"ğŸ”‘ ×”×ª×—×‘×¨":"âœ¨ ×”×™×¨×©×"}
          </button>
        </div>
        <p style={{color:"#475569",fontSize:13,textAlign:"center",marginTop:20}}>
          {mode==="login"?"××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ":"×›×‘×¨ ×¨×©×•×? "}
          <span onClick={()=>{setMode(mode==="login"?"register":"login");setErr("");}} style={{color:"#4ade80",cursor:"pointer",fontWeight:700}}>{mode==="login"?"×”×™×¨×©×":"×”×ª×—×‘×¨"}</span>
        </p>
      </div>
    </div>
  );
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// DIET APP
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function DietApp({user,onOut}) {
  const color = ucolor(user.id);
  const name  = user.name||user.email?.split("@")[0];
  const [tab,setTab]       = useState("weight");
  const [profile,setProfile] = useState({gender:"male",age:"",heightCm:"",weightKg:"",activityLevel:"1.375"});
  const [weights,setWeights] = useState({});
  const [meals,setMeals]   = useState({});
  const [workouts,setWorkouts]=useState({});
  const [steps,setSteps]   = useState({});
  const [loaded,setLoaded] = useState(false);
  const [menu,setMenu]     = useState(false);

  useEffect(()=>{
    Promise.all([api.load("profile"),api.load("weights"),api.load("meals"),api.load("workouts"),api.load("steps")])
      .then(([p,w,m,wo,s])=>{if(p)setProfile(p);setWeights(w||{});setMeals(m||{});setWorkouts(wo||{});setSteps(s||{});setLoaded(true);})
      .catch(()=>setLoaded(true));
  },[user.id]);

  const today = new Date().toISOString().slice(0,10);
  const sv = useCallback(async(key,setter,next)=>{setter(next);try{await api.save(key,next);}catch(e){console.error(e);};},[]);

  if(!loaded) return <Spin/>;

  const latestW   = Object.values(weights).sort((a,b)=>b.date.localeCompare(a.date))[0];
  const effW      = latestW?.kg||parseFloat(profile.weightKg)||null;
  const calc      = effW?calcBMR({...profile,weightKg:effW,activityLevel:parseFloat(profile.activityLevel)}):null;
  const TARGET    = calc?.target||null;
  const tMeals    = meals[today]||[];
  const tWO       = workouts[today]||[];
  const tCal      = tMeals.reduce((s,m)=>s+(m.calories||0),0);
  const workoutBurned = tWO.reduce((s,w)=>s+(w.caloriesBurned||0),0);
  // Estimate steps from workouts to avoid double counting
  // ~1 km = ~1300 steps, running/walking workouts estimated from duration
  const workoutSteps = tWO.reduce((s,w)=>{
    const type = (w.type||"").toLowerCase();
    if (type.includes("×¨×™×¦×”")) return s + (w.duration||0) * 150; // ~150 steps/min running
    if (type.includes("×”×œ×™×›×”")) return s + (w.duration||0) * 100; // ~100 steps/min walking
    if (type.includes("××•×¤× ×™×™×")) return s + (w.duration||0) * 80;
    return s + (w.duration||0) * 60; // other workouts
  }, 0);
  const todaySteps = steps[today]?.count || 0;
  const netSteps = Math.max(0, todaySteps - workoutSteps);
  const stepsBurned = Math.round(netSteps * 0.04);
  const burned    = workoutBurned + stepsBurned;
  const net       = tCal-burned;

  const TABS=[{id:"weight",l:"âš–ï¸ ××©×§×œ"},{id:"food",l:"ğŸ½ï¸ ××•×›×œ"},{id:"workout",l:"ğŸ’ª ××™××•×Ÿ"},{id:"steps",l:"ğŸ‘Ÿ ×¦×¢×“×™×"},{id:"recommend",l:"ğŸ¤– ×”××œ×¦×•×ª"},{id:"profile",l:"âš™ï¸ ×¤×¨×•×¤×™×œ"}];
  const tdee = calc?.tdee || null;
  const bmr = calc?.bmr || null;
  // Deficit = (BMR + workout calories + step calories) - calories eaten
  const deficit = bmr ? (bmr + workoutBurned + stepsBurned - tCal) : (tdee ? (tdee - tCal) : null);

  // Steps box: show count + calories
  const todayStepCount = steps[today]?.count || 0;
  // Workout box: show description + calories
  const todayWorkoutDesc = tWO.length > 0 ? tWO.map(w=>w.detail||w.type).join(", ") : null;

  const sums=[
    ["ğŸ”¥","×¦×¨×›×ª",tCal,"#f97316"],
    ["ğŸ’ª", todayWorkoutDesc||"××™××•×Ÿ", workoutBurned, "#a78bfa", todayWorkoutDesc],
    ["ğŸ‘Ÿ", todayStepCount>0?`${todayStepCount.toLocaleString()} ×¦×¢×“×™×`:"×¦×¢×“×™×", stepsBurned, "#34d399", todayStepCount>0?`${todayStepCount.toLocaleString()} ×¦×¢×“×™×`:null],
    ...(bmr?[["ğŸ§¬","×©×¨×™×¤×ª ×‘×¡×™×¡",bmr,"#60a5fa"]]:tdee?[["ğŸ¯","×©×¨×™×¤×” ×™×•××™×ª",tdee,"#60a5fa"]]:[]),
    ...(deficit!==null?[["ğŸ“Š","×’×¨×¢×•×Ÿ ×§×œ×•×¨×™",deficit,deficit>=0?"#4ade80":"#f87171"]]:
      TARGET?[["ğŸ“Š","× ×˜×•",net,TARGET&&net>TARGET?"#f87171":"#4ade80"]]:[]),
    ["ğŸ’š","× ×©××¨",Math.max(0,(TARGET||tdee||0)-tCal),(TARGET||tdee)&&tCal>(TARGET||tdee)?"#f87171":"#4ade80"],
  ]

  return(
    <div style={{minHeight:"100vh",backgroundColor:"#0a0e1a",fontFamily:"Heebo,sans-serif",color:"#e2e8f0"}}>
      <header style={{background:"linear-gradient(135deg,#0f1a2e 0%,#0a0e1a 100%)",borderBottom:"1px solid #1e293b",padding:"18px 22px 0"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:10,marginBottom:10}}>
          <div>
            <h1 style={{fontSize:22,fontWeight:900,margin:0,background:"linear-gradient(135deg,#4ade80,#60a5fa)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>ğŸ¥— ×“×™××˜×” ×‘×™×—×“</h1>
            <p style={{color:"#64748b",margin:"2px 0 0",fontSize:12}}>×”××¡×¢ ×©×œ× ×• ×œ×—×™×™× ×‘×¨×™××™×</p>
          </div>
          <div style={{position:"relative"}}>
            <button onClick={()=>setMenu(v=>!v)} style={{display:"flex",alignItems:"center",gap:8,padding:"6px 12px 6px 8px",borderRadius:20,border:"1px solid #1e293b",backgroundColor:"#0f1117",cursor:"pointer",fontFamily:"Heebo,sans-serif"}}>
              <Avatar name={name} color={color} size={28}/>
              <span style={{color:"#e2e8f0",fontWeight:600,fontSize:14}}>{name}</span>
              <span style={{color:"#64748b",fontSize:11}}>â–¾</span>
            </button>
            {menu&&<div style={{position:"absolute",top:"calc(100% + 8px)",left:0,backgroundColor:"#0f1117",border:"1px solid #1e293b",borderRadius:14,minWidth:200,boxShadow:"0 10px 30px #00000066",zIndex:20,padding:8}}>
              <div style={{color:"#64748b",fontSize:12,padding:"6px 14px 10px",borderBottom:"1px solid #1e293b"}}>{user.email}</div>
              <button onClick={()=>{setTab("profile");setMenu(false);}} style={{display:"block",width:"100%",padding:"10px 14px",border:"none",backgroundColor:"transparent",color:"#e2e8f0",cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:14,textAlign:"right",borderRadius:8}}>âš™ï¸ ×”×’×“×¨×•×ª</button>
              <button onClick={onOut} style={{display:"block",width:"100%",padding:"10px 14px",border:"none",backgroundColor:"transparent",color:"#f87171",cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:14,textAlign:"right",borderRadius:8}}>ğŸšª ×”×ª× ×ª×§</button>
            </div>}
          </div>
        </div>
        {(!effW||!profile.age||!profile.heightCm)&&<div onClick={()=>setTab("profile")} style={{backgroundColor:"#78350f22",border:"1px solid #f9731644",borderRadius:10,padding:"9px 14px",color:"#f97316",fontSize:13,cursor:"pointer",marginBottom:10}}>âš ï¸ ×”×©×œ× ×¤×¨×•×¤×™×œ ×œ×—×™×©×•×‘ ×§×œ×•×¨×™×•×ª ××“×•×™×§ â†</div>}
        <div style={{display:"flex",gap:8,overflowX:"auto",paddingBottom:14,flexWrap:"wrap"}}>
          {sums.map(([icon,label,val,clr,sublabel],i)=>(
            <div key={i} style={{display:"flex",gap:8,alignItems:"center",padding:"9px 11px",backgroundColor:"#0f1117",borderRadius:12,border:`1px solid ${clr}44`,minWidth:80,flex:1}}>
              <span style={{fontSize:15}}>{icon}</span>
              <div>
                <div style={{fontSize:16,fontWeight:700,color:clr}}>{val} <span style={{fontSize:11,fontWeight:400,color:clr+"aa"}}>×§×§×´×œ</span></div>
                <div style={{fontSize:10,color:"#64748b"}}>{sublabel||label}</div>
              </div>
            </div>
          ))}
        </div>
      </header>
      <nav style={{display:"flex",gap:2,padding:"10px 20px",borderBottom:"1px solid #1e293b",overflowX:"auto"}}>
        {TABS.map(t=><button key={t.id} onClick={()=>setTab(t.id)} style={{padding:"8px 12px",borderRadius:8,border:"none",cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:13,whiteSpace:"nowrap",backgroundColor:tab===t.id?"#1e293b":"transparent",color:tab===t.id?"#e2e8f0":"#64748b"}}>{t.l}</button>)}
      </nav>
      <main style={{padding:20,maxWidth:800,margin:"0 auto"}}>
        {tab==="profile"  &&<ProfileTab profile={profile} save={p=>sv("profile",setProfile,p)} calc={calc} effW={effW} name={name} color={color} weights={weights} workouts={workouts} meals={meals} steps={steps}/>}
        {tab==="weight"   &&<WeightTab  weights={weights} add={(d,kg)=>sv("weights",setWeights,{...weights,[d]:{date:d,kg}})} today={today} color={color}/>}
        {tab==="food"     &&<FoodTab
          meals={meals}
          add={(d,e)=>{const p=meals[d]||[];sv("meals",setMeals,{...meals,[d]:[...p,e]});}}
          deleteMeal={(d,i)=>{const updated={...meals,[d]:(meals[d]||[]).filter((_,j)=>j!==i)};sv("meals",setMeals,updated);}}
          updateMealItem={(d,mealIdx,itemIdx,newItem)=>{
            const updated={...meals};
            updated[d]=[...meals[d]];
            updated[d][mealIdx]={...meals[d][mealIdx]};
            updated[d][mealIdx].items=[...meals[d][mealIdx].items];
            // newItem can be object {amount, calories} or just a string (amount)
            const oldItem = meals[d][mealIdx].items[itemIdx];
            const updatedItem = typeof newItem === "object" 
              ? {...oldItem, ...newItem}
              : {...oldItem, amount: newItem};
            updated[d][mealIdx].items[itemIdx] = updatedItem;
            // Recalculate total calories for this meal
            const newTotalCal = updated[d][mealIdx].items.reduce((s,it)=>s+(it.calories||0),0);
            updated[d][mealIdx] = {...updated[d][mealIdx], calories: newTotalCal};
            sv("meals",setMeals,updated);
          }}
          today={today} tCal={tCal} target={TARGET} tdee={calc?.tdee}/>}
        {tab==="workout"  &&<WorkoutTab
          workouts={workouts}
          add={(d,e)=>{const p=workouts[d]||[];sv("workouts",setWorkouts,{...workouts,[d]:[...p,e]});}}
          deleteWorkout={(d,i)=>{const updated={...workouts,[d]:(workouts[d]||[]).filter((_,j)=>j!==i)};sv("workouts",setWorkouts,updated);}}
          today={today} effW={effW}/>}
        {tab==="steps"    &&<StepsTab   steps={steps} add={(d,c)=>sv("steps",setSteps,{...steps,[d]:{date:d,count:c}})} today={today} color={color} workouts={workouts}/>}
        {tab==="recommend"&&<RecommendTab profile={profile} calc={calc} tMeals={tMeals} tCal={tCal} net={net} target={TARGET} name={name} burned={burned}/>}
      </main>
      {menu&&<div onClick={()=>setMenu(false)} style={{position:"fixed",inset:0,zIndex:9}}/>}
    </div>
  );
}

// â”€â”€ Shared UI â”€â”€
function Card({title,children}){return<div style={{backgroundColor:"#0f1117",borderRadius:16,border:"1px solid #1e293b",padding:20,marginBottom:16,animation:"fadeIn .2s ease"}}>{title&&<h3 style={{fontSize:13,fontWeight:700,margin:"0 0 14px",color:"#64748b",textTransform:"uppercase",letterSpacing:".06em"}}>{title}</h3>}{children}</div>;}
function Inp({style,...p}){return<input {...p} style={{padding:"10px 14px",borderRadius:10,border:"1px solid #1e293b",backgroundColor:"#0a0e1a",color:"#e2e8f0",fontFamily:"Heebo,sans-serif",fontSize:14,outline:"none",flex:1,...style}}/>;}
function Btn({children,style,...p}){return<button {...p} style={{padding:"10px 20px",borderRadius:10,border:"none",backgroundColor:"#4ade80",color:"#0a0e1a",fontWeight:700,cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:14,...style}}>{children}</button>;}
function BBox({label,sub,val,color,hi}){return<div style={{flex:1,minWidth:88,padding:"14px 10px",backgroundColor:"#0a0e1a",borderRadius:12,border:hi?`2px solid ${color}88`:"1px solid #1e293b",backgroundColor:hi?color+"11":"#0a0e1a",textAlign:"center"}}><div style={{color,fontSize:hi?30:24,fontWeight:900}}>{val}</div><div style={{color,fontSize:13,fontWeight:700,marginTop:2}}>{label}</div><div style={{color:"#64748b",fontSize:11,marginTop:3}}>{sub}</div></div>;}
function PT({children}){return<h2 style={{fontSize:20,fontWeight:700,margin:"0 0 16px"}}>{children}</h2>;}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PROFILE TAB
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function ProfileTab({profile,save,calc,effW,name,color,weights,workouts,meals,steps}){
  const [f,setF]=useState({...profile});
  const [saved,setSaved]=useState(false);
  const u=(k,v)=>setF(p=>({...p,[k]:v}));
  const prev=effW&&f.age&&f.heightCm?calcBMR({...f,weightKg:effW,age:+f.age,heightCm:+f.heightCm,activityLevel:+f.activityLevel}):null;
  const ACTS=[{v:"1.2",l:"×™×•×©×‘× ×™ ×××•×“",s:"××©×¨×“, ×›××¢×˜ ×œ×œ× ×¤×¢×™×œ×•×ª"},{v:"1.375",l:"×¤×¢×™×œ ×§×¦×ª",s:"1â€“3 ××™××•× ×™× ×‘×©×‘×•×¢"},{v:"1.55",l:"×¤×¢×™×œ ×‘×™× ×•× ×™",s:"3â€“5 ××™××•× ×™× ×‘×©×‘×•×¢"},{v:"1.725",l:"×¤×¢×™×œ ×××•×“",s:"6â€“7 ××™××•× ×™× ×‘×©×‘×•×¢"}];
  async function go(){await save(f);setSaved(true);setTimeout(()=>setSaved(false),2000);}
  return(
    <div>
      <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:20}}>
        <Avatar name={name} color={color} size={50}/>
        <div><h2 style={{margin:0,fontSize:22,fontWeight:700}}>{name}</h2><p style={{margin:0,color:"#64748b",fontSize:13}}>×”×¤×¨×•×¤×™×œ ×©×œ×š</p></div>
      </div>
      <Card title="ğŸ“‹ ×¤×¨×˜×™× ××™×©×™×™×">
        <div style={{display:"flex",gap:10,marginBottom:14}}>
          {[{v:"male",l:"ğŸ‘¨ ×’×‘×¨"},{v:"female",l:"ğŸ‘© ××™×©×”"}].map(({v,l})=>(
            <button key={v} onClick={()=>u("gender",v)} style={{flex:1,padding:10,borderRadius:10,border:"1px solid #1e293b",backgroundColor:"transparent",cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:14,fontWeight:600,...(f.gender===v?{backgroundColor:color+"22",borderColor:color,color}:{color:"#94a3b8"})}}>{l}</button>
          ))}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:14}}>
          <div><label style={{color:"#64748b",fontSize:13,fontWeight:600}}>×’×™×œ</label><Inp type="number" placeholder="35" value={f.age} onChange={e=>u("age",e.target.value)} style={{width:"100%",marginTop:4}}/></div>
          <div>
            <label style={{color:"#64748b",fontSize:13,fontWeight:600}}>×’×•×‘×” (×¡×´×)</label>
            <Inp type="number" placeholder="175" value={f.heightCm} onChange={e=>u("heightCm",e.target.value)} style={{width:"100%",marginTop:4}}/>
            {f.heightCm && parseFloat(f.heightCm) < 10 && <div style={{color:"#f87171",fontSize:12,marginTop:4}}>âš ï¸ ×”×›× ×¡ ×‘×¡× ×˜×™××˜×¨×™×! ×œ××©×œ: 175 ×•×œ× 1.75</div>}
          </div>
        </div>
        <div style={{marginBottom:18}}>
          <label style={{color:"#64748b",fontSize:13,fontWeight:600}}>××©×§×œ ×”×ª×—×œ×ª×™ (×§×´×’)</label>
          <Inp type="number" placeholder="80" value={f.weightKg} onChange={e=>u("weightKg",e.target.value)} style={{maxWidth:180,marginTop:4}}/>
          {effW&&<div style={{color:"#4ade80",fontSize:12,marginTop:4}}>âœ“ ××—×•×©×‘ ×œ×¤×™ ××©×§×œ ××¢×•×“×›×Ÿ: {effW} ×§×´×’</div>}
        </div>
        <label style={{color:"#64748b",fontSize:13,fontWeight:600}}>×¨××ª ×¤×¢×™×œ×•×ª</label>
        <div style={{display:"flex",flexDirection:"column",gap:7,marginTop:6}}>
          {ACTS.map(({v,l,s})=>(
            <button key={v} onClick={()=>u("activityLevel",v)} style={{display:"flex",alignItems:"center",gap:8,padding:"10px 14px",borderRadius:10,border:"1px solid #1e293b",backgroundColor:"transparent",cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:13,textAlign:"right",...(f.activityLevel===v?{backgroundColor:"#1e3a5f",borderColor:"#60a5fa",color:"#e2e8f0"}:{color:"#94a3b8"})}}>
              <span style={{color:"#60a5fa",fontWeight:700,minWidth:38}}>Ã—{v}</span><span style={{fontWeight:600}}>{l}</span><span style={{color:"#64748b",fontSize:12}}> â€” {s}</span>
            </button>
          ))}
        </div>
        <Btn onClick={go} style={{width:"100%",marginTop:18,...(saved?{backgroundColor:"#22c55e"}:{})}}>{saved?"âœ“ × ×©××¨!":"ğŸ’¾ ×©××•×¨"}</Btn>
      </Card>
      {prev&&<Card title="ğŸ“Š ×”××“×“×™× ×©×œ×š">
        {(()=>{
          const bmi = effW && f.heightCm ? (effW / Math.pow(f.heightCm/100, 2)).toFixed(1) : null;
          const bmiLabel = !bmi ? "" : bmi<18.5 ? "×ª×ª ××©×§×œ" : bmi<25 ? "âœ… ×ª×§×™×Ÿ" : bmi<30 ? "×¢×•×“×£ ××©×§×œ" : "×”×©×× ×”";
          const bmiColor = !bmi ? "#64748b" : bmi<18.5 ? "#60a5fa" : bmi<25 ? "#4ade80" : bmi<30 ? "#f97316" : "#f87171";
          return <div style={{display:"flex",gap:10,flexWrap:"wrap",marginBottom:16}}>
            <BBox label="BMI" sub={bmiLabel} val={bmi||"â€”"} color={bmiColor} hi/>
            <BBox label="ğŸ”¥ ×§×œ×•×¨×™×•×ª ××•××œ×¦×•×ª" sub="×œ×™×¨×™×“×” ×©×œ Â½ ×§×´×’ ×‘×©×‘×•×¢" val={prev.target} color="#4ade80" hi/>
            <BBox label="âš¡ ×©×¨×™×¤×” ×™×•××™×ª" sub="×›×•×œ×œ ×¤×¢×™×œ×•×ª" val={prev.tdee} color="#60a5fa"/>
          </div>;
        })()}
        <div style={{backgroundColor:"#0a0e1a",borderRadius:10,padding:"12px 14px",fontSize:13,color:"#94a3b8",lineHeight:1.8}}>
          <div>ğŸ“ ×’×•×‘×”: <strong style={{color:"#e2e8f0"}}>{f.heightCm} ×¡×´×</strong> &nbsp;|&nbsp; âš–ï¸ ××©×§×œ: <strong style={{color:"#e2e8f0"}}>{effW} ×§×´×’</strong> &nbsp;|&nbsp; ğŸ‚ ×’×™×œ: <strong style={{color:"#e2e8f0"}}>{f.age}</strong></div>
          <div style={{marginTop:8,padding:"8px 12px",backgroundColor:"#0f1117",borderRadius:8,fontSize:12,lineHeight:1.7}}>
            <div style={{color:"#60a5fa",fontWeight:600,marginBottom:2}}>ğŸ§¬ ×©×¨×™×¤×ª ×‘×¡×™×¡ (BMR) = {prev.bmr} ×§×§×´×œ</div>
            <div style={{color:"#64748b"}}>×–×” ×›××•×ª ×”×§×œ×•×¨×™×•×ª ×©×’×•×¤×š ×©×•×¨×£ ×‘×™×•× ×™×•× <strong style={{color:"#94a3b8"}}>×‘×œ×™ ×©×•× ×¤×¢×™×œ×•×ª</strong> â€” ×¨×§ ×œ× ×©×•×, ×œ×™×©×•×Ÿ, ×œ×¢×›×œ.</div>
            <div style={{color:"#60a5fa",fontWeight:600,marginTop:6,marginBottom:2}}>âš¡ ×©×¨×™×¤×” ×™×•××™×ª (TDEE) = {prev.tdee} ×§×§×´×œ</div>
            <div style={{color:"#64748b"}}>BMR Ã— ×¨××ª ×¤×¢×™×œ×•×ª â€” ×–×” ×›××” ××ª×” ×©×•×¨×£ ×‘×¤×•×¢×œ ×›×œ ×™×•× ×›×•×œ×œ ×¤×¢×™×œ×•×ª.</div>
            <div style={{color:"#4ade80",fontWeight:600,marginTop:6,marginBottom:2}}>ğŸ¯ ×™×¢×“ ×œ×™×¨×™×“×” ×‘××©×§×œ = {prev.target} ×§×§×´×œ</div>
            <div style={{color:"#64748b"}}>TDEE ×¤×—×•×ª 500 ×§×§×´×œ = ×™×¨×™×“×” ×©×œ ×›-Â½ ×§×´×’ ×‘×©×‘×•×¢.</div>
          </div>
        </div>
      </Card>}

      {/* BMI History based on weight entries */}
      {weights && Object.keys(weights).length>0 && f.heightCm && parseFloat(f.heightCm)>10 && (()=>{
        const hCm = parseFloat(f.heightCm);
        const bmiHistory = Object.values(weights)
          .sort((a,b)=>b.date.localeCompare(a.date))
          .slice(0,10)
          .map(w=>{
            const bmi = (w.kg / Math.pow(hCm/100,2)).toFixed(1);
            const label = bmi<18.5?"×ª×ª ××©×§×œ":bmi<25?"×ª×§×™×Ÿ":bmi<30?"×¢×•×“×£":"×”×©×× ×”";
            const color = bmi<18.5?"#60a5fa":bmi<25?"#4ade80":bmi<30?"#f97316":"#f87171";
            return {...w, bmi, label, color};
          });
        return <Card title="ğŸ“ˆ ×”×™×¡×˜×•×¨×™×™×ª BMI">
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
            <thead><tr style={{borderBottom:"1px solid #1e293b"}}>
              <th style={{textAlign:"right",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×ª××¨×™×š</th>
              <th style={{textAlign:"center",padding:"6px 8px",color:"#64748b",fontWeight:600}}>××©×§×œ</th>
              <th style={{textAlign:"center",padding:"6px 8px",color:"#64748b",fontWeight:600}}>BMI</th>
              <th style={{textAlign:"right",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×¡×˜×˜×•×¡</th>
            </tr></thead>
            <tbody>
              {bmiHistory.map((w,i)=>(
                <tr key={i} style={{borderBottom:"1px solid #1e293b22"}}>
                  <td style={{padding:"8px",color:"#64748b"}}>{w.date}</td>
                  <td style={{padding:"8px",textAlign:"center",color:"#e2e8f0",fontWeight:600}}>{w.kg} ×§×´×’</td>
                  <td style={{padding:"8px",textAlign:"center",color:w.color,fontWeight:700}}>{w.bmi}</td>
                  <td style={{padding:"8px",color:w.color,fontSize:12}}>{w.label}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>;
      })()}

      {/* Daily calorie burn history */}
      {workouts && meals && (()=>{
        const allDates = new Set([
          ...Object.keys(workouts),
          ...Object.keys(meals),
          ...Object.keys(steps||{})
        ]);
        if(allDates.size===0) return null;
        const burnHistory = [...allDates]
          .sort((a,b)=>b.localeCompare(a))
          .slice(0,14)
          .map(d=>{
            const dayWO = workouts[d]||[];
            const dayMeals = meals[d]||[];
            const daySteps = steps?.[d]?.count||0;
            const woBurned = dayWO.reduce((s,w)=>s+(w.caloriesBurned||0),0);
            const stepsBurned = Math.round(daySteps*0.04);
            const totalBurned = woBurned+stepsBurned;
            const totalEaten = dayMeals.reduce((s,m)=>s+(m.calories||0),0);
            const deficit = totalBurned-totalEaten;
            return {date:d, burned:totalBurned, eaten:totalEaten, deficit, woBurned, stepsBurned};
          })
          .filter(d=>d.burned>0||d.eaten>0);
        if(burnHistory.length===0) return null;
        return <Card title="ğŸ”¥ ×”×™×¡×˜×•×¨×™×™×ª ×§×œ×•×¨×™×•×ª ×™×•××™×ª">
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
            <thead><tr style={{borderBottom:"1px solid #1e293b"}}>
              <th style={{textAlign:"right",padding:"6px 6px",color:"#64748b",fontWeight:600}}>×ª××¨×™×š</th>
              <th style={{textAlign:"center",padding:"6px 6px",color:"#64748b",fontWeight:600}}>× ×©×¨×£</th>
              <th style={{textAlign:"center",padding:"6px 6px",color:"#64748b",fontWeight:600}}>× ××›×œ</th>
              <th style={{textAlign:"center",padding:"6px 6px",color:"#64748b",fontWeight:600}}>×’×¨×¢×•×Ÿ</th>
            </tr></thead>
            <tbody>
              {burnHistory.map((d,i)=>(
                <tr key={i} style={{borderBottom:"1px solid #1e293b22"}}>
                  <td style={{padding:"7px 6px",color:"#64748b"}}>{d.date}</td>
                  <td style={{padding:"7px 6px",textAlign:"center",color:"#a78bfa",fontWeight:600}}>{d.burned}</td>
                  <td style={{padding:"7px 6px",textAlign:"center",color:"#f97316",fontWeight:600}}>{d.eaten}</td>
                  <td style={{padding:"7px 6px",textAlign:"center",color:d.deficit>=0?"#4ade80":"#f87171",fontWeight:700}}>
                    {d.deficit>0?"+":""}{d.deficit}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>;
      })()}
    </div>
  );
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// WEIGHT TAB
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function WeightTab({weights,add,today,color}){
  const [kg,setKg]=useState("");
  const [date,setDate]=useState(today);
  const sorted=Object.values(weights).sort((a,b)=>a.date.localeCompare(b.date));
  const first=sorted[0]?.kg,last=sorted[sorted.length-1]?.kg;
  const diff=sorted.length>1?(last-first).toFixed(1):null;
  const chartData=sorted.map(w=>({date:w.date.slice(5),val:w.kg}));

  return(
    <div>
      <PT>âš–ï¸ ××¢×§×‘ ××©×§×œ</PT>
      <Card>
        <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
          <Inp type="date" value={date} onChange={e=>setDate(e.target.value)}/>
          <Inp type="number" placeholder="×§×´×’" value={kg} onChange={e=>setKg(e.target.value)} style={{maxWidth:120}}/>
          <Btn onClick={()=>{if(kg&&date){add(date,parseFloat(kg));setKg("");}}} >×©××•×¨ âœ“</Btn>
        </div>
      </Card>
      {diff!==null&&<Card>
        <div style={{display:"flex",gap:20,justifyContent:"center",flexWrap:"wrap",textAlign:"center"}}>
          <div><div style={{color:"#94a3b8",fontSize:26,fontWeight:700}}>{first}</div><div style={{color:"#64748b",fontSize:12}}>×”×ª×—×œ×”</div></div>
          <div style={{color:"#475569",fontSize:28,alignSelf:"center"}}>â†’</div>
          <div><div style={{color,fontSize:26,fontWeight:700}}>{last}</div><div style={{color:"#64748b",fontSize:12}}>×¢×›×©×™×•</div></div>
          <div><div style={{color:parseFloat(diff)<=0?"#4ade80":"#f87171",fontSize:26,fontWeight:700}}>{parseFloat(diff)<=0?"":"+"}{diff} ×§×´×’</div><div style={{color:"#64748b",fontSize:12}}>{parseFloat(diff)<=0?"ğŸ‰ ×™×¨×“×ª!":"ğŸ“ˆ ×¢×œ×™×ª"}</div></div>
        </div>
      </Card>}
      {chartData.length>1&&<Card title="ğŸ“ˆ ×’×¨×£ ×”×ª×§×“××•×ª"><LineChart data={chartData} xKey="date" yKey="val" color={color} height={200}/></Card>}
      {sorted.length>0&&<Card title="ğŸ“‹ ×”×™×¡×˜×•×¨×™×”">{[...sorted].reverse().slice(0,10).map((w,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"10px 0",borderBottom:"1px solid #1e293b"}}><span style={{color:"#64748b"}}>{w.date}</span><span style={{color,fontWeight:700,fontSize:18}}>{w.kg} ×§×´×’</span></div>)}</Card>}
    </div>
  );
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FOOD TAB
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function FoodTab({meals,add,deleteMeal,updateMealItem,today,tCal,target,tdee}){
  const [text,setText]=useState("");
  const [date,setDate]=useState(today);
  const [loading,setLoading]=useState(false);
  const [err,setErr]=useState("");
  const entries=meals[date]||[];

  async function analyze(){
    if(!text.trim())return;
    setLoading(true);setErr("");
    try{
      // Check server-side food cache first
      let data = null;
      try {
        const cacheRes = await api.post("/api/food-cache/lookup", {text});
        if(cacheRes.hit) {
          data = cacheRes.data;
        }
      } catch(e) { /* cache miss, continue to Claude */ }

      if(!data) {
        const r=await callClaude([{role:"user",content:text}],
          `××ª×” ×× ×ª×— ×ª×–×•× ×” ×™×©×¨××œ×™. ×—×œ×¥ ××–×•× ×•×ª ××˜×§×¡×˜ ×—×•×¤×©×™. ×”×—×–×¨ JSON ×‘×œ×‘×“:
          {"items":[{
            "name":"×©× ×”××•×¦×¨",
            "amount":"×ª×™××•×¨ ×›××•×ª",
            "calories":0,"protein":0,"carbs":0,"fat":0,"sugar":0,"fiber":0,
            "countable": true/false,
            "units": ××¡×¤×¨ ×™×—×™×“×•×ª (×¨×§ ×× countable=true, ××—×¨×ª null),
            "gramsPerUnit": ×’×¨× ×œ×™×—×™×“×” ××—×ª (×¨×§ ×× countable=true, ××—×¨×ª null),
            "grams": ×¡×”×´×› ×’×¨××™×
          }],
          "total":{"calories":0,"protein":0,"carbs":0,"fat":0,"sugar":0,"fiber":0},
          "summary":"×ª×™××•×¨ ×§×¦×¨"}
          countable=true ×¨×§ ×œ××•×¦×¨×™× ×©×¡×•×¤×¨×™× ×‘×™×—×™×“×•×ª: ×¢×•×£,×‘×™×¦×”,×¤×¨×™,×œ×—×× ×™×”,×¤×™×ª×”,×§×¦×™×¦×” ×•×›×•×³.
          countable=false ×œ××•×¦×¨×™× ×©× ××“×“×™× ×‘×’×¨×/×›×£/×›×•×¡: ××•×¨×–,×˜×—×™× ×”,×©××Ÿ,×’×‘×™× ×”,×™×¨×§×•×ª ×§×¦×•×¦×™× ×•×›×•×³.
          JSON ×ª×§×™×Ÿ ×‘×œ×‘×“ ×œ×œ× ×”×¡×‘×¨×™×.`);
        try{data=JSON.parse(r.replace(/```json|```/g,"").trim());}catch{setErr("×œ× ×”×¦×œ×—×ª×™ ×œ× ×ª×—.");setLoading(false);return;}
        // Save to cache for future use
        try { await api.post("/api/food-cache/save", {text, data}); } catch(e){}
      }

      add(date,{
        text,
        items:data.items||[],
        calories:data.total?.calories||0,
        protein:data.total?.protein||0,
        carbs:data.total?.carbs||0,
        fat:data.total?.fat||0,
        sugar:data.total?.sugar||0,
        fiber:data.total?.fiber||0,
        summary:data.summary||"",
        time:new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})
      });
      setText("");
    }catch(e){setErr("×©×’×™××”: "+e.message);}
    setLoading(false);
  }

  const pct=(tdee||target)?Math.min(110,(tCal/(tdee||target))*100):0;
  return(
    <div>
      <PT>ğŸ½ï¸ ××” ××›×œ×ª?</PT>
      <Card>
        <Inp type="date" value={date} onChange={e=>setDate(e.target.value)} style={{display:"block",width:"100%",marginBottom:10}}/>
        <textarea placeholder={"×›×ª×•×‘ ×‘×˜×§×¡×˜ ×—×•×¤×©×™...\n\"××›×œ×ª×™ 2 ×›×¨×¢×™ ×¢×•×£, 3 ×›×¤×•×ª ××•×¨×– ×•×©×œ×™×©×™×ª ×›×•×¡ ×˜×—×™× ×”\""} value={text} onChange={e=>setText(e.target.value)}
          style={{width:"100%",minHeight:85,padding:"12px 14px",borderRadius:10,border:"1px solid #1e293b",backgroundColor:"#0a0e1a",color:"#e2e8f0",fontFamily:"Heebo,sans-serif",fontSize:14,outline:"none",resize:"vertical",boxSizing:"border-box",marginBottom:10}}/>
        <Btn onClick={analyze} style={loading?{opacity:.6}:{}} disabled={loading}>{loading?"â³ ×× ×ª×—...":"ğŸ” × ×ª×— ×§×œ×•×¨×™×•×ª"}</Btn>
        {err&&<p style={{color:"#f87171",marginTop:8,fontSize:13}}>{err}</p>}
      </Card>
      {target&&date===today&&<div style={{backgroundColor:"#0f1117",borderRadius:16,border:"1px solid #1e293b",padding:16,marginBottom:16}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}>
          <span style={{color:"#94a3b8"}}>×§×œ×•×¨×™×•×ª ×”×™×•×</span>
          <span style={{fontWeight:700,color:tCal>target?"#f87171":"#4ade80"}}>{tCal} <span style={{color:"#475569",fontWeight:400}}>/ {tdee||target} ×§×§×´×œ ×©×¨×™×¤×” ×™×•××™×ª</span></span>
        </div>
        <div style={{height:10,backgroundColor:"#1e293b",borderRadius:10,overflow:"hidden"}}><div style={{height:"100%",width:pct+"%",borderRadius:10,transition:"width .5s",backgroundColor:pct>=100?"#f87171":pct>80?"#f97316":"#4ade80"}}/></div>
        <div style={{display:"flex",justifyContent:"space-between",marginTop:6,fontSize:12}}>
          <span style={{color:tCal>target?"#f87171":"#64748b"}}>{tCal<=target?`âœ… × ×©××¨: ${target-tCal} ×§×§×´×œ`:`âš ï¸ ×—×¨×’×ª ×‘-${tCal-target} ×§×§×´×œ`}</span>
          <span style={{color:"#475569"}}>×™×¢×“ ×™×¨×™×“×”: {target} ×§×§×´×œ</span>
        </div>
      </div>}
      {Object.keys(meals).length>1&&(()=>{
        const history = Object.entries(meals)
          .map(([d,entries])=>({date:d, cal:entries.reduce((s,e)=>s+(e.calories||0),0)}))
          .sort((a,b)=>b.date.localeCompare(a.date))
          .slice(0,14);
        return <Card title="ğŸ“… ×”×™×¡×˜×•×¨×™×” ×™×•××™×ª">
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
              <thead>
                <tr style={{borderBottom:"1px solid #1e293b"}}>
                  <th style={{textAlign:"right",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×ª××¨×™×š</th>
                  <th style={{textAlign:"center",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×§×œ×•×¨×™×•×ª</th>
                  <th style={{textAlign:"center",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×¡×˜×˜×•×¡</th>
                </tr>
              </thead>
              <tbody>
                {history.map(({date:d,cal})=>{
                  const ok = target ? cal<=target : true;
                  const pctDay = target ? Math.min(100,(cal/target)*100) : 50;
                  return <tr key={d} style={{borderBottom:"1px solid #1e293b22"}}>
                    <td style={{padding:"8px 8px",color:"#94a3b8"}}>{d}</td>
                    <td style={{padding:"8px 8px",textAlign:"center",color:ok?"#4ade80":"#f87171",fontWeight:700}}>{cal}</td>
                    <td style={{padding:"8px 8px",textAlign:"center"}}>
                      <div style={{height:6,backgroundColor:"#1e293b",borderRadius:4,overflow:"hidden",minWidth:80}}>
                        <div style={{height:"100%",width:pctDay+"%",backgroundColor:ok?"#4ade80":"#f87171",borderRadius:4}}/>
                      </div>
                    </td>
                  </tr>;
                })}
              </tbody>
            </table>
          </div>
        </Card>;
      })()}

      {entries.length>0&&<Card title={`ğŸ“‹ ××¨×•×—×•×ª â€” ${date}`}>
        {entries.map((e,i)=>(
          <MealCard key={i} entry={e}
            onDelete={()=>{
              const updated={...meals,[date]:entries.filter((_,j)=>j!==i)};
              add._deleteMeal ? add._deleteMeal(date,i) : (() => {
                const newMeals={...meals,[date]:entries.filter((_,j)=>j!==i)};
                deleteMeal(date,i);
              })();
            }}
            onUpdateItem={(itemIdx,newAmount)=>{
              updateMealItem(date,i,itemIdx,newAmount);
            }}
          />
        ))}
        <div style={{borderTop:"1px solid #1e293b",marginTop:10,paddingTop:10,display:"flex",justifyContent:"space-between",fontWeight:700}}><span style={{color:"#64748b"}}>×¡×”×´×›</span><span style={{color:"#f97316"}}>{entries.reduce((s,e)=>s+e.calories,0)} ×§×§×´×œ</span></div>
      </Card>}
    </div>
  );
}



// â”€â”€ Meal Card â”€â”€
function MealCard({entry, onDelete, onUpdateItem}) {
  const [open, setOpen] = useState(false);
  return (
    <div style={{padding:"12px 0",borderBottom:"1px solid #1e293b"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
        <div style={{flex:1,cursor:"pointer"}} onClick={()=>setOpen(v=>!v)}>
          <div style={{color:"#e2e8f0",fontWeight:600,fontSize:14}}>{entry.summary||entry.text?.slice(0,60)}</div>
          <div style={{color:"#64748b",fontSize:12}}>{entry.time}</div>
        </div>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <div style={{color:"#f97316",fontWeight:700}}>{entry.calories} ×§×§×´×œ</div>
          <button onClick={()=>setOpen(v=>!v)} style={{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:11}}>{open?"â–²":"â–¼"}</button>
          <button onClick={onDelete} style={{background:"none",border:"none",color:"#f87171",cursor:"pointer",fontSize:16,padding:"0 4px"}} title="××—×§">ğŸ—‘ï¸</button>
        </div>
      </div>
      {open && (
        <div style={{marginTop:12,paddingTop:10,borderTop:"1px solid #1e293b"}}>
          <div style={{display:"flex",gap:7,flexWrap:"wrap",marginBottom:10}}>
            {[["×—×œ×‘×•×Ÿ",entry.protein,"#4ade80"],["×¤×—××™××•×ª",entry.carbs,"#60a5fa"],["×©×•××Ÿ",entry.fat,"#f97316"],["×¡×•×›×¨",entry.sugar,"#f472b6"],["×¡×™×‘×™×",entry.fiber,"#a78bfa"]].map(([l,v,c])=>(
              <div key={l} style={{padding:"7px 10px",borderRadius:10,border:`1px solid ${c}55`,textAlign:"center",minWidth:54}}>
                <div style={{color:c,fontSize:13,fontWeight:700}}>{v}g</div><div style={{color:"#64748b",fontSize:10}}>{l}</div>
              </div>
            ))}
          </div>
          {entry.items?.map((item,i)=>(
            <ItemRow key={i} item={item} onUpdate={onUpdateItem ? (newAmt)=>onUpdateItem(i,newAmt) : null}/>
          ))}
        </div>
      )}
    </div>
  );
}

// â”€â”€ Item Row with editable quantity and calorie recalc â”€â”€
function ItemRow({item, onUpdate}) {
  const [localItem, setLocalItem] = useState(item);
  const [editingUnits, setEditingUnits] = useState(false);
  const [editingGrams, setEditingGrams] = useState(false);
  const [unitsVal, setUnitsVal] = useState("");
  const [gramsVal, setGramsVal] = useState("");

  // Determine if item is countable (has units) or weight-only
  const isCountable = item.countable === true || 
    /^(×›×¨×¢|×¨×’×œ ×¢×•×£|×—×–×” ×¢×•×£|×©× ×™×¦×œ|×‘×™×¦|×ª×¤×•×—|×‘× × |×¢×’×‘× ×™|××œ×¤×¤|×›×“×•×¨|×¤×™×ª×”|×œ×—×× ×™|×”××‘×•×¨×’×¨|×§×¦×™×¦|×©×™×¤×•×“|×¡×˜×™×™×§|×¤×¨×•×¡×”)/i.test(item.name||"");
  
  const gramsPerUnit = item.gramsPerUnit || item.grams || 
    (item.amount && /(\d+)\s*g/.test(item.amount) ? parseFloat(item.amount.match(/(\d+)\s*g/)[1]) : null);
  const units = item.units || 
    (item.amount && /^([\d.]+)\s*(×™×—×™×“×•×ª|unit)/i.test(item.amount) ? parseFloat(item.amount) : 1);
  
  const calPerGram = gramsPerUnit && units ? localItem.calories / (gramsPerUnit * units) : null;
  const calPerUnit = units > 0 ? localItem.calories / units : localItem.calories;

  function confirmUnits() {
    const newUnits = parseFloat(unitsVal);
    if (!newUnits || newUnits <= 0) { setEditingUnits(false); return; }
    const newCal = Math.round(calPerUnit * newUnits);
    const newGrams = gramsPerUnit ? Math.round(gramsPerUnit * newUnits) : null;
    const updated = {...localItem, units: newUnits, calories: newCal,
      amount: newGrams ? `${newUnits} ×™×—×™×“×•×ª (${newGrams}g)` : `${newUnits} ×™×—×™×“×•×ª`};
    setLocalItem(updated);
    if (onUpdate) onUpdate({amount: updated.amount, calories: newCal, units: newUnits});
    setEditingUnits(false);
  }

  function confirmGrams() {
    const newGrams = parseFloat(gramsVal);
    if (!newGrams || newGrams <= 0) { setEditingGrams(false); return; }
    const newCal = calPerGram ? Math.round(calPerGram * newGrams) : localItem.calories;
    const newUnitsFromGrams = gramsPerUnit ? (newGrams / gramsPerUnit).toFixed(1) : null;
    const updated = {...localItem, calories: newCal,
      amount: newUnitsFromGrams && isCountable ? `${newUnitsFromGrams} ×™×—×™×“×•×ª (${newGrams}g)` : `${newGrams}g`};
    setLocalItem(updated);
    if (onUpdate) onUpdate({amount: updated.amount, calories: newCal});
    setEditingGrams(false);
  }

  const inp = {padding:"3px 8px",borderRadius:6,border:"1px solid #4ade80",backgroundColor:"#0f1117",color:"#e2e8f0",fontFamily:"Heebo,sans-serif",fontSize:13,textAlign:"center"};
  const numBox = (val, onClick) => (
    <span onClick={onClick} style={{minWidth:40,padding:"3px 10px",borderRadius:6,border:"1px solid #1e293b",backgroundColor:"#0a0e1a",color:"#e2e8f0",cursor:"pointer",fontSize:13,textAlign:"center",display:"inline-block"}}>
      {val}
    </span>
  );
  const confirmBtn = (fn) => (
    <button onClick={fn} style={{padding:"3px 10px",borderRadius:6,border:"none",backgroundColor:"#4ade80",color:"#0a0e1a",fontWeight:700,cursor:"pointer",fontSize:12}}>âœ“</button>
  );

  // Display current values
  const displayUnits = localItem.units || units;
  const displayGrams = localItem.amount?.match(/(\d+)g/) ? parseInt(localItem.amount.match(/(\d+)g/)[1]) : gramsPerUnit;

  return (
    <div style={{padding:"10px 0",borderTop:"1px solid #1e293b22"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,marginBottom:6}}>
        <span style={{color:"#cbd5e1",flex:1,fontSize:13,fontWeight:600}}>{localItem.name}</span>
        <span style={{color:"#f97316",fontSize:14,fontWeight:700}}>{localItem.calories} ×§×§×´×œ</span>
      </div>
      <div style={{display:"flex",gap:16,flexWrap:"wrap"}}>
        {isCountable && (
          <div style={{display:"flex",alignItems:"center",gap:6}}>
            <span style={{color:"#64748b",fontSize:11}}>×™×—×™×“×•×ª:</span>
            {editingUnits ? (
              <><input autoFocus value={unitsVal} onChange={e=>setUnitsVal(e.target.value)}
                onKeyDown={e=>e.key==="Enter"&&confirmUnits()} style={{...inp,width:55}}/>{confirmBtn(confirmUnits)}</>
            ) : numBox(displayUnits, ()=>{setUnitsVal(String(displayUnits));setEditingUnits(true);})}
          </div>
        )}
        {(displayGrams||gramsPerUnit) && (
          <div style={{display:"flex",alignItems:"center",gap:6}}>
            <span style={{color:"#64748b",fontSize:11}}>×’×¨×:</span>
            {editingGrams ? (
              <><input autoFocus value={gramsVal} onChange={e=>setGramsVal(e.target.value)}
                onKeyDown={e=>e.key==="Enter"&&confirmGrams()} style={{...inp,width:65}}/>{confirmBtn(confirmGrams)}</>
            ) : numBox(displayGrams||gramsPerUnit||"?", ()=>{setGramsVal(String(displayGrams||gramsPerUnit||""));setEditingGrams(true);})}
          </div>
        )}
      </div>
    </div>
  );
}


// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// WORKOUT TAB
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function WorkoutTab({workouts,add,deleteWorkout,today,effW}){
  const [type,setType]=useState("×¨×™×¦×”");
  const [detail,setDetail]=useState("");
  const [date,setDate]=useState(today);
  const [loading,setLoading]=useState(false);
  const TYPES=["×¨×™×¦×”","×”×œ×™×›×”","××•×¤× ×™×™×","×©×—×™×™×”","×—×“×¨ ×›×•×©×¨","×™×•×’×”","××—×¨"];

  async function go(){
    if(!detail.trim())return;
    setLoading(true);
    try{
      const userWeight = effW || 75; // fallback to 75kg if unknown
      const r=await callClaude([{role:"user",content:`${type}: ${detail}`}],
        `××ª×” ××—×©×‘ ×©×¨×™×¤×ª ×§×œ×•×¨×™×•×ª ×œ×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª. ××©×§×œ ×”××©×ª××©: ${userWeight} ×§"×’.
        ×”×©×ª××© ×‘× ×•×¡×—××•×ª MET ××“×•×™×§×•×ª (×§×œ×•×¨×™×•×ª = MET Ã— ××©×§×œ_×§"×’ Ã— ×©×¢×•×ª):
        - ×¨×™×¦×” 5-6 ×“×§×³/×§"× (×§×¦×‘ ×˜×•×‘): MET 11
        - ×¨×™×¦×” 6-7 ×“×§×³/×§"× (×§×¦×‘ ×‘×™× ×•× ×™): MET 9.8  
        - ×¨×™×¦×” 7-8 ×“×§×³/×§"× (×§×¦×‘ ××™×˜×™): MET 8
        - ×”×œ×™×›×” ××”×™×¨×”: MET 4.5 | ×”×œ×™×›×” ×¨×’×™×œ×”: MET 3.5
        - ××•×¤× ×™×™× ×—×™×¦×•× ×™ ×¢×¦×™×: MET 8 | ×¡×¤×™× ×™× ×’: MET 11
        - ×©×—×™×™×”: MET 8 | ×—×“×¨ ×›×•×©×¨: MET 5 | ×™×•×’×”: MET 2.5
        ×—×©×‘ ×œ×¤×™ ×”× ×•×¡×—×”: ×§×œ×•×¨×™×•×ª = MET Ã— ${userWeight} Ã— (×“×§×•×ª/60)
        ×—×œ×¥ ××”×˜×§×¡×˜: ××¨×—×§ ×‘×§"×, ×–××Ÿ ×‘×“×§×•×ª, ×§×¦×‘ ×× ×™×©.
        ×”×—×–×¨ JSON ×‘×œ×‘×“ ×œ×œ× ×˜×§×¡×˜ × ×•×¡×£:
        {"calories_burned":××¡×¤×¨_×©×œ×,"duration_minutes":××¡×¤×¨_×©×œ×,"distance_km":××¡×¤×¨_××•_null,"description":"×ª×™××•×¨ ×§×¦×¨ ×‘×¢×‘×¨×™×ª"}`);
      let data;try{data=JSON.parse(r.replace(/```json|```/g,"").trim());}catch{data={calories_burned:0,duration_minutes:0,description:detail};}
      add(date,{type,detail,caloriesBurned:data.calories_burned||0,duration:data.duration_minutes||0,distanceKm:data.distance_km||null,description:data.description||detail,time:new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})});
      setDetail("");
    }catch{}
    setLoading(false);
  }

  // All workouts history sorted by date desc
  const allHistory = Object.entries(workouts)
    .flatMap(([d,ws])=>ws.map(w=>({...w,date:d})))
    .sort((a,b)=>b.date.localeCompare(a.date));

  const dw=workouts[date]||[];
  return(
    <div>
      <PT>ğŸ’ª ××™××•×Ÿ</PT>
      <Card>
        <Inp type="date" value={date} onChange={e=>setDate(e.target.value)} style={{display:"block",width:"100%",marginBottom:10}}/>
        <div style={{display:"flex",gap:7,flexWrap:"wrap",marginBottom:12}}>
          {TYPES.map(t=><button key={t} onClick={()=>setType(t)} style={{padding:"6px 14px",borderRadius:20,border:"1px solid #1e293b",backgroundColor:"transparent",cursor:"pointer",fontFamily:"Heebo,sans-serif",fontSize:13,...(type===t?{backgroundColor:"#4ade8022",color:"#4ade80",borderColor:"#4ade80"}:{color:"#94a3b8"})}}>{t}</button>)}
        </div>
        <Inp placeholder={`×¤×¨×˜×™×: "5 ×§"× ×ª×•×š 28 ×“×§×•×ª"`} value={detail} onChange={e=>setDetail(e.target.value)} onKeyDown={e=>e.key==="Enter"&&go()}/>
        <Btn onClick={go} style={{marginTop:10,...(loading?{opacity:.6}:{})}} disabled={loading}>{loading?"â³ ××—×©×‘...":"â• ×”×•×¡×£"}</Btn>
      </Card>
      {dw.length>0&&<Card title={`ğŸƒ ××™××•× ×™× â€” ${date}`}>
        {dw.map((w,i)=>(
          <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:"1px solid #1e293b"}}>
            <div style={{flex:1}}>
              <span style={{color:"#a78bfa",fontWeight:600}}>{w.type} </span>
              <span style={{color:"#94a3b8",fontSize:13}}>{w.description}</span>
              <div style={{color:"#64748b",fontSize:11}}>{w.time} Â· {w.duration} ×“×§×³ Â· {w.detail}</div>
            </div>
            <div style={{display:"flex",alignItems:"center",gap:10}}>
              <span style={{color:"#4ade80",fontWeight:700}}>âˆ’{w.caloriesBurned} ×§×§×´×œ</span>
              <button onClick={()=>deleteWorkout&&deleteWorkout(date,i)} style={{background:"none",border:"none",color:"#f87171",cursor:"pointer",fontSize:15}}>ğŸ—‘ï¸</button>
            </div>
          </div>
        ))}
        <div style={{paddingTop:10,display:"flex",justifyContent:"space-between",fontWeight:700}}><span style={{color:"#64748b"}}>×¡×”×´×› × ×©×¨×£</span><span style={{color:"#4ade80"}}>âˆ’{dw.reduce((s,w)=>s+w.caloriesBurned,0)} ×§×§×´×œ</span></div>
      </Card>}
      {allHistory.length>0&&<Card title="ğŸ“… ×”×™×¡×˜×•×¨×™×™×ª ××™××•× ×™×">
        <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
          <thead>
            <tr style={{borderBottom:"1px solid #1e293b"}}>
              <th style={{textAlign:"right",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×ª××¨×™×š</th>
              <th style={{textAlign:"right",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×¡×•×’</th>
              <th style={{textAlign:"right",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×¤×¨×˜×™×</th>
              <th style={{textAlign:"center",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×“×§×³</th>
              <th style={{textAlign:"left",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×§×§×´×œ</th>
            </tr>
          </thead>
          <tbody>
            {allHistory.slice(0,20).map((w,i)=>(
              <tr key={i} style={{borderBottom:"1px solid #1e293b22"}}>
                <td style={{padding:"8px",color:"#64748b",fontSize:12}}>{w.date}</td>
                <td style={{padding:"8px"}}><span style={{color:"#a78bfa",fontWeight:600}}>{w.type}</span></td>
                <td style={{padding:"8px",color:"#94a3b8",fontSize:12}}>{w.detail||w.description}</td>
                <td style={{padding:"8px",textAlign:"center",color:"#64748b"}}>{w.duration}</td>
                <td style={{padding:"8px",textAlign:"left",color:"#4ade80",fontWeight:700}}>âˆ’{w.caloriesBurned}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </Card>}
    </div>
  );
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// STEPS TAB
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function StepsTab({steps,add,today,color,workouts}){
  const [count,setCount]=useState("");
  const [date,setDate]=useState(today);
  const sorted=Object.values(steps).sort((a,b)=>a.date.localeCompare(b.date));
  const todayE=steps[today];
  const GOAL=10000;
  const chartData=sorted.map(s=>({date:s.date.slice(5),val:s.count}));
  // Calculate workout steps to show deduction
  const tWO = workouts[today]||[];
  const workoutSteps = Math.round(tWO.reduce((s,w)=>{
    const type=(w.type||"").toLowerCase();
    if(type.includes("×¨×™×¦×”")) return s+(w.duration||0)*150;
    if(type.includes("×”×œ×™×›×”")) return s+(w.duration||0)*100;
    if(type.includes("××•×¤× ×™×™×")) return s+(w.duration||0)*80;
    return s+(w.duration||0)*60;
  },0));
  const netSteps = Math.max(0,(todayE?.count||0)-workoutSteps);

  return(
    <div>
      <PT>ğŸ‘Ÿ ×¦×¢×“×™×</PT>
      <Card>
        <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
          <Inp type="date" value={date} onChange={e=>setDate(e.target.value)}/>
          <Inp type="number" placeholder="××¡×¤×¨ ×¦×¢×“×™×" value={count} onChange={e=>setCount(e.target.value)} style={{maxWidth:160}}/>
          <Btn onClick={()=>{if(count){add(date,parseInt(count));setCount("");}}} >×©××•×¨ âœ“</Btn>
        </div>
      </Card>
      {todayE&&<Card title="ğŸ¯ ×™×¢×“ ×™×•××™ â€” 10,000 ×¦×¢×“×™×">
        <div style={{textAlign:"center",marginBottom:10}}>
          <div style={{fontSize:52,fontWeight:900,color:todayE.count>=GOAL?"#4ade80":color}}>{todayE.count.toLocaleString()}</div>
          <div style={{color:"#64748b"}}>××ª×•×š {GOAL.toLocaleString()}</div>
        </div>
        <div style={{height:10,backgroundColor:"#1e293b",borderRadius:10,overflow:"hidden"}}><div style={{height:"100%",width:Math.min(100,(todayE.count/GOAL)*100)+"%",borderRadius:10,transition:"width .5s",backgroundColor:todayE.count>=GOAL?"#4ade80":color}}/></div>
        <div style={{display:"flex",justifyContent:"space-between",marginTop:8,fontSize:13,color:"#64748b"}}>
          <span>{netSteps>=GOAL?"ğŸ‰ ×”×’×¢×ª ×œ×™×¢×“!":`×¢×•×“ ${Math.max(0,GOAL-netSteps).toLocaleString()} ×¦×¢×“×™× × ×•×¡×¤×™×`}</span>
          <span>â‰ˆ {Math.round(netSteps*.04)} ×§×§×´×œ</span>
        </div>
        {workoutSteps>0&&<div style={{marginTop:8,padding:"8px 12px",backgroundColor:"#1e293b",borderRadius:8,fontSize:12,color:"#94a3b8"}}>
          â„¹ï¸ ×”×•×¤×—×ª×• ~{workoutSteps.toLocaleString()} ×¦×¢×“×™× ××”××™××•×Ÿ â€” ×œ× ×™×—×•×©×‘×• ×¤×¢××™×™×
        </div>}
      </Card>}
      {chartData.length>1&&<Card title="ğŸ“ˆ ×’×¨×£ ×¦×¢×“×™×"><LineChart data={chartData} xKey="date" yKey="val" color={color} height={180}/></Card>}
      {sorted.length>1&&<Card title="ğŸ“… ×”×™×¡×˜×•×¨×™×™×ª ×¦×¢×“×™×">
        <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
          <thead>
            <tr style={{borderBottom:"1px solid #1e293b"}}>
              <th style={{textAlign:"right",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×ª××¨×™×š</th>
              <th style={{textAlign:"center",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×¦×¢×“×™×</th>
              <th style={{textAlign:"center",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×™×¢×“</th>
              <th style={{textAlign:"left",padding:"6px 8px",color:"#64748b",fontWeight:600}}>×§×§×´×œ</th>
            </tr>
          </thead>
          <tbody>
            {[...sorted].reverse().slice(0,14).map((s,i)=>{
              const reached = s.count>=GOAL;
              return <tr key={i} style={{borderBottom:"1px solid #1e293b22"}}>
                <td style={{padding:"8px",color:"#64748b",fontSize:12}}>{s.date}</td>
                <td style={{padding:"8px",textAlign:"center",color:reached?"#4ade80":color,fontWeight:700}}>{s.count.toLocaleString()}</td>
                <td style={{padding:"8px",textAlign:"center"}}>{reached?"ğŸ‰":"â€”"}</td>
                <td style={{padding:"8px",textAlign:"left",color:"#34d399"}}>â‰ˆ{Math.round(s.count*0.04)}</td>
              </tr>;
            })}
          </tbody>
        </table>
      </Card>}
    </div>
  );
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// RECOMMEND TAB
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function RecommendTab({profile,calc,tMeals,tCal,net,target,name,burned}){
  const [rec,setRec]=useState("");
  const [loading,setLoading]=useState(false);
  const tdee = calc?.tdee || target;
  const remaining = tdee ? Math.max(0, tdee - tCal) : null;
  // Deficit = (BMR + workout + steps) - eaten
  const deficit = calc?.bmr ? (calc.bmr + (burned||0) - tCal) : (tdee ? tdee - tCal : null);

  async function go(){
    setLoading(true);setRec("");
    const summary=tMeals.map(m=>m.summary||m.text).join(", ")||"×œ× ××›×œ×ª ×¢×“×™×™×Ÿ";
    const pstr=profile.age?`×’×™×œ ${profile.age}, ×’×•×‘×” ${profile.heightCm} ×¡"×, ${profile.gender==="male"?"×’×‘×¨":"××™×©×”"}`:"";
    try{
      const r=await callClaude([{role:"user",content:`×©×: ${name}. ${pstr?`×¤×¨×•×¤×™×œ: ${pstr}.`:""} ××›×œ×ª×™: ${summary}. ×¦×¨×›×ª×™ ${tCal} ×§×œ×•×¨×™×•×ª.${target?` × ×©××¨: ${remaining} ×§×œ×•×¨×™×•×ª (×™×¢×“: ${target}).`:""} ×ª×Ÿ ×”××œ×¦×•×ª.`}],
        `××ª×” ×“×™××˜× ×™×ª ×™×©×¨××œ×™×ª ××™×•×× ×ª. ×¤× ×” ×™×©×™×¨×•×ª ×œ×¤×™ ×”×©×. ×”××œ×¦×•×ª ×¡×¤×¦×™×¤×™×•×ª ×‘×¢×‘×¨×™×ª ×¢× ×›××•×™×•×ª. ×™×“×™×“×•×ª×™ ×•××¢×•×“×“. ×¢×“ 320 ××™×œ×™×.`);
      setRec(r);
    }catch{setRec("×©×’×™××”, × ×¡×” ×©×•×‘.");}
    setLoading(false);
  }

  return(
    <div>
      <PT>ğŸ¤– ×”××œ×¦×•×ª AI</PT>
      {calc&&<Card title="ğŸ“Š ×”×¡×˜×˜×•×¡ ×©×œ×š ×”×™×•×">
        <div style={{display:"flex",gap:10,flexWrap:"wrap"}}>
          <BBox label="×¦×¨×›×ª" sub="×§×§×´×œ ×”×™×•×" val={tCal} color="#f97316"/>
          <BBox label="×©×¨×™×¤×” ×™×•××™×ª" sub="TDEE" val={tdee||"â€”"} color="#60a5fa"/>
          <BBox label="× ×©××¨ ×œ××›×•×œ" sub="×¢×“ ×œ×©×¨×™×¤×”" val={remaining??("â€”")} color={remaining!==null&&remaining<=0?"#f87171":"#4ade80"} hi/>
        </div>
        {deficit!==null&&<div style={{marginTop:12,padding:"12px 14px",borderRadius:10,backgroundColor:deficit>=0?"#0d2a1a":"#2a0d0d",border:`1px solid ${deficit>=0?"#4ade8044":"#f8717144"}`}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <span style={{color:"#94a3b8",fontSize:13}}>×’×¨×¢×•×Ÿ ×§×œ×•×¨×™ ×”×™×•×</span>
            <span style={{fontSize:20,fontWeight:700,color:deficit>=0?"#4ade80":"#f87171"}}>{deficit>0?"+":""}{deficit} ×§×§×´×œ</span>
          </div>
          <div style={{color:"#64748b",fontSize:12,marginTop:4}}>
            {deficit>=0
              ? `âœ… ××ª×” ×‘×’×¨×¢×•×Ÿ â€” ×©×¨×¤×ª ${deficit} ×§×§×´×œ ×™×•×ª×¨ ×××” ×©××›×œ×ª`
              : `âš ï¸ ××ª×” ×‘×¢×•×“×£ â€” ××›×œ×ª ${Math.abs(deficit)} ×§×§×´×œ ×™×•×ª×¨ ×××” ×©× ×©×¨×£`}
          </div>
          {deficit>=500&&<div style={{color:"#4ade80",fontSize:12,marginTop:2}}>ğŸ¯ ×’×¨×¢×•×Ÿ ××¦×•×™×Ÿ! ××¢×œ 500 ×§×§×´×œ = ×™×¨×™×“×” ×™×¢×™×œ×” ×‘××©×§×œ</div>}
        </div>}
      </Card>}
      <Card>
        <Btn onClick={go} style={{width:"100%",fontSize:15,padding:14,...(loading?{opacity:.6}:{})}} disabled={loading}>
          {loading?`â³ ××™×™×¦×¨ ×”××œ×¦×•×ª...`:`âœ¨ ××” ×œ××›×•×œ ×¢×›×©×™×•, ${name}?`}
        </Btn>
      </Card>
      {rec&&<Card title="ğŸ’¡ ×”×”××œ×¦×•×ª ×©×œ×™"><div style={{color:"#cbd5e1",lineHeight:1.9,whiteSpace:"pre-wrap",fontSize:15}}>{rec}</div></Card>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
